# Story 6.3: Add Story Comments

**Status:** Draft

**Epic:** 6.0 Advanced Story Structure

**Story:**

**As an** AI Agent,
**I want** to add comments to a user story,
**so that** I can provide additional context, ask questions, or record discussions related to the story.

**Acceptance Criteria:**

1. The Story data model is extended to include a list of comments.
2. Tools are available to add comments to a story.
3. `backlog.getStory` returns the comments associated with a story.

**Tasks / Subtasks:**

- [ ] **Extend Story Data Model with Comments Field** (AC: 1)
  - [ ] Modify Story model to support comments with fields: `{'id': str, 'author_role': str, 'content': str, 'timestamp': datetime, 'reply_to_id': str | None}`
  - [ ] Update Story model validation to ensure comment structure format
  - [ ] Update Story.to_dict() method to include comments field
  - [ ] Create database migration for comments structure change

- [ ] **Implement Comment Management Tools** (AC: 2)
  - [ ] Create `comments.addToStory` tool to add new comments to a story
  - [ ] Add proper validation for comment operations (story exists, author role validation, etc.)
  - [ ] Support optional reply_to_id for threaded conversations

- [ ] **Update Story Retrieval to Include Comments** (AC: 3)
  - [ ] Modify `backlog.getStory` tool to return comments field in response
  - [ ] Update StoryResponse Pydantic model to include comments field
  - [ ] Ensure comments are properly serialized in API responses with timestamp formatting
  - [ ] Update story repository methods to handle comments field

- [ ] **Create Unit Tests for Comment Functionality**
  - [ ] Test Story model with comments field validation
  - [ ] Test comment management tools with various scenarios
  - [ ] Test edge cases: empty comments, invalid comment structure, etc.
  - [ ] Test timestamp handling and reply_to_id functionality

- [ ] **Integration Tests Verified**
  - [ ] Existing integration tests pass with comments field included
  - [ ] Story retrieval integration maintains backward compatibility
  - [ ] Database persistence verified through existing test infrastructure

- [ ] **Code Quality Validation - MANDATORY** ⚠️
  - [ ] Run `ruff check .` - All linting checks **MUST** pass
  - [ ] Run `mypy .` - All type checking **MUST** pass
  - [ ] Fix any linting or type errors before story completion
  - [ ] Verify no new warnings or errors introduced

**Dev Notes:**

**Project Context:**
This story extends the Story data model to support comments as structured data, enabling AI agents and human reviewers to add contextual information, ask questions, or record discussions related to a story. This aligns with the BMAD method for enhanced story collaboration and context management.

**Dependencies:**
- **RECOMMENDED**: Stories 6.1 and 6.2 completed for task management and structured acceptance criteria pattern reference
- Part of Epic 6.0 Advanced Story Structure & BMAD Method Alignment

**Previous Story Insights (from Stories 6.1 & 6.2):**
- Tasks and structured acceptance criteria fields successfully implemented as JSON columns with validation structure
- Management tools pattern established: add, update status, update description, reorder operations
- Database migration pattern established for adding JSON columns to stories table
- StoryResponse model extension pattern proven for backward compatibility

**Tech Stack & Dependencies:**
[Source: architecture/tech-stack.md]
- **Language**: Python ~3.11
- **Data Validation**: Pydantic (Latest) - Data validation and serialization for consistent JSON responses
- **MCP SDK**: FastMCP (Latest) - Handles MCP communication, tool definition, and web server
- **Database**: SQLite ~3.37+ - Local, file-based relational database
- **ORM**: SQLAlchemy ~2.0 - Database toolkit and ORM for data access
- **Testing**: Pytest ~8.2.2 - Testing framework for unit and E2E tests

**Data Models:**
[Source: architecture/data-models.md#Story]
- **Story Entity**: Currently contains tasks and structured_acceptance_criteria as JSON fields - needs extension for comments
- **Comment Structure**: From ERD - contains id, story_id, author_role, content, timestamp, reply_to_id (optional)

**Target Comment Structure (following established JSON field pattern):**
```python
# Each comment structure:
{
    'id': str,           # Unique identifier within story
    'author_role': str,  # Role of commenter (e.g., 'Developer Agent', 'QA Agent', 'Human Reviewer')
    'content': str,      # The comment text content
    'timestamp': datetime, # When comment was created (ISO format for JSON serialization)
    'reply_to_id': str | None  # Optional - ID of comment this is replying to for threading
}
```

**Relevant Source Tree:**
[Source: architecture/source-tree.md]
```
src/agile_mcp/
├── models/
│   ├── story.py                     # Story entity model - needs comments field extension
│   └── response.py                  # StoryResponse model - needs comments field addition
├── api/
│   └── story_tools.py               # Story management tools - needs comment tools
├── repositories/
│   └── story_repository.py          # Story data operations - may need comment methods
└── services/
    └── story_service.py             # Story business logic - may need comment validation
```

**API Tool Pattern (following established patterns from Stories 6.1 & 6.2):**
- Tool naming: `comments.{action}` following established pattern
- Primary operation: `addToStory` for adding comments
- Validation: story exists, author_role validation, proper structure format
- Response: Use appropriate Pydantic response models
- Timestamp handling: Automatic timestamp generation for new comments

**Implementation Approach:**
1. **Extend Story model** - Add comments field following tasks/acceptance criteria JSON pattern
2. **Create comment management tools** - Following task/AC management tool patterns from Stories 6.1/6.2
3. **Update StoryResponse** - Include comments in API responses with proper timestamp serialization
4. **Backward compatibility** - Ensure existing functionality continues to work
5. **Migration strategy** - Handle existing stories without comments field

**Testing:**

**Framework:** Pytest
**Test Locations:**
- **Unit Tests**: `tests/unit/test_story_model.py`, `tests/unit/test_story_tools.py`
- **Integration Tests**: `tests/integration/test_story_flow.py`
- **E2E Tests**: `tests/e2e/test_story_tools_e2e.py`

**Testing Standards:**
[Source: architecture/testing-strategy.md]
- **Unit Tests**: Focus on Story model validation and comment management functions in isolation
- **Integration Tests**: Test interaction between Service Layer and Repository Layer for comment operations
- **E2E Tests**: Validate MCP protocol compliance for comment management tools via stdio transport
- **Database Testing**: Use temporary SQLite database with transaction rollback for clean state
- **Test Isolation**: Each test runs independently with proper setup/teardown

**Success Criteria:**
- Story model supports comments with proper validation including timestamp and threading
- Comment management tools provide CRUD operations following established patterns
- StoryResponse includes comments field with proper timestamp serialization
- All existing tests pass with new comments field included
- Backward compatibility maintained for existing stories

**Change Log:**

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-29 | 1.0 | Initial story creation following Stories 6.1/6.2 pattern | Bob (Scrum Master) |

**Dev Agent Record:**

**Agent Model Used:**

**Debug Log References:**

**Completion Notes List:**

**File List:**

**QA Results:**
