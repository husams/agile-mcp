# Story 6.2: Implement Structured Document Storage

**Status:** ToDo

**Epic:** 6.0 Agent Workflow & Model Enhancements

**Story:**

**As an** Analyst Agent,
**I want** to ingest documents into a structured database model, broken down by sections,
**so that** other agents can query for specific, granular context without loading entire files.

**Acceptance Criteria:**

1. A `Document` data model is created, linked to a `Project`.
2. A `DocumentSection` data model is created, linked to a `Document`, containing `title` (from Markdown heading) and `content`.
3. An `documents.ingest` tool is created that accepts a file's content, parses it into sections based on Markdown headings, and saves it to the database.
4. A `documents.getSection` tool is created to retrieve the content of a specific section by its title or ID.

**Tasks / Subtasks:**

- [ ] **Create Document Data Model** (AC: 1)
  - [ ] Create `Document` model in `src/agile_mcp/models/document.py`
  - [ ] Add SQLAlchemy mapping with id, project_id (foreign key), title, file_path, created_at
  - [ ] Add relationship to Project model
  - [ ] Add validation for required fields
  - [ ] Add to_dict() method and DocumentResponse Pydantic model

- [ ] **Create DocumentSection Data Model** (AC: 2)
  - [ ] Create `DocumentSection` model in same file or separate module
  - [ ] Add SQLAlchemy mapping with id, document_id (foreign key), title, content, order
  - [ ] Add relationship to Document model
  - [ ] Add validation for section title and content
  - [ ] Add to_dict() method and DocumentSectionResponse model

- [ ] **Implement Document Ingestion Tool** (AC: 3)
  - [ ] Create `documents.ingest` tool in new document_tools.py
  - [ ] Implement Markdown parsing logic to extract sections by headings
  - [ ] Handle different heading levels (H1, H2, H3, etc.)
  - [ ] Store document and sections in database atomically
  - [ ] Add proper validation for file content and project association
  - [ ] Create DocumentService for business logic

- [ ] **Implement Section Retrieval Tool** (AC: 4)
  - [ ] Create `documents.getSection` tool
  - [ ] Support retrieval by section title or ID
  - [ ] Support querying sections within specific documents or projects
  - [ ] Return structured section data with metadata
  - [ ] Add proper error handling for missing sections

- [ ] **Create Markdown Parser Utility**
  - [ ] Create utility class for parsing Markdown into sections
  - [ ] Handle edge cases: nested headings, code blocks, tables
  - [ ] Preserve content formatting within sections
  - [ ] Support different Markdown heading syntaxes

- [ ] **Create Unit Tests for Document Functionality**
  - [ ] Test Document and DocumentSection model validation
  - [ ] Test Markdown parsing utility with various formats
  - [ ] Test document ingestion with complex Markdown files
  - [ ] Test section retrieval by title and ID
  - [ ] Test error handling for malformed documents

- [ ] **Integration Tests and Repository Layer**
  - [ ] Create DocumentRepository for data access patterns
  - [ ] Test document-project relationship queries
  - [ ] Test section querying and filtering capabilities
  - [ ] Test atomic document+sections creation
  - [ ] Verify database constraints and referential integrity

**Dev Notes:**

**Context from PRD:**
This story enables structured document ingestion that allows agents to query specific document sections rather than loading entire files. This is critical for the agent workflow model enhancements, particularly for the Scrum Master agent to gather targeted context.

**Technical Implementation:**
- Use established patterns from Project/Epic/Story models
- Implement robust Markdown parsing (consider using existing library like `markdown` or `mistune`)
- Ensure atomic operations for document+sections ingestion
- Design for scalability with large documents and many sections

**Dependencies:**
- **REQUIRED**: Story 6.1 (Project Entity) - Documents must link to Projects
- Foundation for Story Creation Workflow enhancements

**Markdown Parsing Strategy:**
- Parse headings as section boundaries (H1, H2, H3, etc.)
- Extract section title from heading text
- Capture content between headings as section content
- Maintain section order for reconstruction
- Handle edge cases: no headings, nested structures, code blocks

**Change Log:**

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-31 | 1.0 | Created missing Structured Document Storage story from PRD | John (PM) |
