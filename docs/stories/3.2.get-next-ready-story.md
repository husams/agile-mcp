# Story 3.2: Get Next Ready Story

## Status
Draft

## Story
**As a** Developer Agent,
**I want** to request the next story that is ready for implementation,
**so that** I can work on the highest-priority task that is not blocked by any dependencies.

## Acceptance Criteria
1. A `backlog.getNextReadyStory` tool is available.
2. The tool returns the highest-priority story with a "ToDo" status that has no incomplete dependencies.
3. If multiple stories are ready, the one with the earliest creation date is returned.
4. If no stories are ready, the tool returns a null or empty response.
5. When a story is retrieved via this tool, its status is automatically updated to "InProgress".

## Tasks / Subtasks
- [ ] Task 0: Update Story Model with Required Fields (AC: 2, 3)
  - [ ] Add priority field (integer) to Story model with default value
  - [ ] Add created_at field (datetime) to Story model with auto-timestamp
  - [ ] Update Story.__init__ method to handle new fields
  - [ ] Update Story.to_dict() method to include new fields
  - [ ] Add database migration or update existing tables
  - [ ] Update unit tests for Story model validation
- [ ] Task 1: Enhance Repository Layer for Query Operations (AC: 2, 3)
  - [ ] Add method to DependencyRepository to check if a story has incomplete dependencies
  - [ ] Add method to StoryRepository to get stories by status with ordering by created_at
  - [ ] Add unit tests for new repository methods
- [ ] Task 2: Implement Service Layer Logic (AC: 2, 3, 4, 5)
  - [ ] Create method in StoryService to find next ready story based on priority and dependencies
  - [ ] Implement logic to check dependencies using DependencyRepository
  - [ ] Implement automatic status update to "InProgress" when story is retrieved
  - [ ] Handle edge case where no stories are ready (return None)
  - [ ] Add comprehensive unit tests for service logic
- [ ] Task 3: Implement FastMCP Tool in API Layer (AC: 1, 2, 3, 4, 5)
  - [ ] Create backlog.getNextReadyStory tool with proper type hints and docstring
  - [ ] Implement tool logic to call StoryService and format response
  - [ ] Handle null case by returning appropriate empty response
  - [ ] Register tool with FastMCP server instance in main.py
  - [ ] Add unit tests for tool implementation
- [ ] Task 4: Add Integration Tests (AC: 1, 2, 3, 4, 5)
  - [ ] Test complete workflow with stories having dependencies
  - [ ] Test priority ordering when multiple stories are ready
  - [ ] Test creation date ordering for same-priority stories
  - [ ] Test automatic status update to InProgress
  - [ ] Test empty response when no stories are ready
- [ ] Task 5: Add End-to-End Tests (AC: 1, 2, 3, 4, 5)
  - [ ] E2E test for backlog.getNextReadyStory via MCP JSON-RPC
  - [ ] Test with complex dependency scenarios
  - [ ] Test status update persistence
  - [ ] Test interaction with existing dependency and story tools
- [ ] Task 6: Execute and Validate All Tests (AC: 1, 2, 3, 4, 5)
  - [ ] Run complete test suite: `pytest tests/`
  - [ ] Verify 100% pass rate - NO EXCEPTIONS
  - [ ] Fix any failing tests before proceeding
  - [ ] Document test execution results in Dev Agent Record
  - [ ] Confirm story completion only after all tests pass

## Dev Notes

### Previous Story Insights
From Story 3.1 completion: Dependency management system is fully operational with DependencyRepository and DependencyService providing robust circular dependency detection. The 3-layer architecture pattern is well-established. Story dependencies are stored in the story_dependencies association table with proper foreign key constraints. The backlog.addDependency tool successfully integrates with the existing story management system.

### Tech Stack & Dependencies
[Source: architecture/tech-stack.md]
- **Language**: Python ~3.11
- **MCP SDK**: FastMCP (Latest) - handles MCP communication, tool definition, and web server
- **Database**: SQLite ~3.37+ (local, file-based relational database)
- **ORM**: SQLAlchemy ~2.0 (database toolkit and ORM)
- **Testing**: Pytest ~8.2.2

### Architecture Patterns
[Source: architecture/high-level-architecture.md#architectural-and-design-patterns]
- **3-Layer Architecture**: Must implement three distinct layers:
  1. **API/Tool Layer**: FastMCP tool implementation with @mcp.tool() decorator
  2. **Service/Business Logic Layer**: Core logic for finding next ready story
  3. **Data Access/Repository Layer**: Enhance existing repositories for dependency checking
- **Repository Pattern**: Extend StoryRepository and DependencyRepository with new query methods
- **Monolithic Service**: Single deployable unit with all layers integrated

### Data Models
[Source: architecture/data-models.md]
**Story Entity (Requires Updates):**
- **id**: string - Unique identifier
- **title**: string - A short, descriptive title
- **status**: string - Current state (ToDo, InProgress, Review, Done)
- **created_at**: datetime - **MISSING - needs to be added** - Timestamp when story was created (for ordering)
- **priority**: integer - **MISSING - needs to be added** - Priority level for ordering (higher number = higher priority)
- **epic_id**: string - Reference to parent epic
- **Dependencies**: Many-to-many relationship via story_dependencies table

**Story Dependency Table (Existing from Story 3.1):**
- **story_id**: string - The story that has the dependency
- **depends_on_story_id**: string - The story that must be completed first

### Business Logic Requirements
- **Ready Story Definition**: A story is "ready" if:
  - Status is "ToDo"
  - All stories it depends on have status "Done"
  - Story exists in the database
- **Priority Ordering**: Stories should be ordered by:
  1. Priority (highest first) - field needs to be added to Story model
  2. Created date (earliest first) for same priority - field needs to be added to Story model
- **Status Update**: When retrieved, story status must change from "ToDo" to "InProgress"
- **Empty Response**: When no stories are ready, return empty dict {}

### MCP Tool Implementation Pattern
[Source: architecture/mcp-server-implementation-examples.md]
Tool must follow FastMCP SDK patterns:
```python
@mcp.tool()
def get_next_ready_story() -> dict:
    """
    Gets the next story that is ready for implementation.
    Returns the highest-priority ToDo story with no incomplete dependencies.
    Automatically updates the story status to InProgress.
    """
    try:
        story = story_service.get_next_ready_story()
        if story:
            return story.to_dict()
        else:
            return {}  # Empty dict when no stories ready
    except Exception as e:
        raise McpError(code=-32001, message=str(e))
```

### File Locations and Project Structure
Based on established patterns from previous stories:
- **Repository Layer Enhancement**: 
  - `src/agile_mcp/repositories/story_repository.py` - Add query methods
  - `src/agile_mcp/repositories/dependency_repository.py` - Add dependency checking
- **Service Layer Enhancement**: 
  - `src/agile_mcp/services/story_service.py` - Add get_next_ready_story method
- **API/Tool Layer**: 
  - `src/agile_mcp/api/backlog_tools.py` - Add get_next_ready_story tool
- **Tests**: 
  - `tests/unit/test_story_service_ready.py` - Service unit tests
  - `tests/unit/test_backlog_tools_ready.py` - Tool unit tests
  - `tests/integration/test_ready_story_flow.py` - Integration tests
  - `tests/e2e/test_get_next_ready_story_e2e.py` - E2E tests

### Query Implementation Considerations
- **Dependency Check Query**: Need efficient query to check if all dependencies are complete
- **Ordering Query**: Need to order by priority (if exists) then by created_at
- **Transaction Safety**: Status update must be atomic with story retrieval
- **Performance**: Consider query optimization for large backlogs

### Error Handling Requirements
[Source: architecture/high-level-architecture.md - extrapolated from patterns]
- **Service Layer**: Handle edge cases gracefully
  - No stories with ToDo status
  - All ToDo stories have incomplete dependencies
  - Database query failures
- **API/Tool Layer**: Translate exceptions to MCP errors
- **Empty Response Format**: Needs clarification - {} or null?

### Security Considerations
- **Input Validation**: No direct user input for this tool
- **Status Transition**: Ensure only valid status transitions (ToDo → InProgress)
- **Concurrency**: Consider race conditions if multiple agents request simultaneously

### Open Questions for Implementation
1. **Priority Field**: ✅ RESOLVED - Will add priority field (integer) to Story model in Task 0
2. **Empty Response Format**: ✅ RESOLVED - Will return {} when no stories ready
3. **Concurrent Access**: How to handle if multiple developer agents request simultaneously?
4. **Status Rollback**: Should there be a way to return story to ToDo if agent fails?
5. **Default Priority**: What should be the default priority value for existing stories?

## Testing

### **MANDATORY TESTING EXECUTION**
**CRITICAL**: Before marking this story complete, developer MUST:
- **Execute**: `pytest tests/` to run full test suite
- **Verify**: 100% pass rate required - NO EXCEPTIONS  
- **Fix**: Any failing tests before story completion
- **Document**: Test execution results in Dev Agent Record

### Testing Standards for Developer
[Source: architecture/testing-strategy.md]
- **Framework**: Pytest ~8.2.2
- **Test File Locations**: 
  - Unit tests: `tests/unit/`
  - Integration tests: `tests/integration/`
  - End-to-end tests: `tests/e2e/`
- **Test Command**: Run `pytest tests/` to execute full test suite
- **Pass Requirement**: 100% pass rate required before story completion

### Testing Requirements for This Story

**Unit Tests**:
- Test StoryRepository query methods with various data scenarios
- Test DependencyRepository incomplete dependency checking
- Test StoryService.get_next_ready_story with:
  - Stories with no dependencies
  - Stories with complete dependencies  
  - Stories with incomplete dependencies
  - Multiple stories with same/different priorities
  - No ready stories scenario
- Test automatic status update logic
- Test tool response formatting

**Integration Tests**:
- Test complete flow from tool to database
- Test with real database transactions
- Verify status persistence after retrieval
- Test dependency checking with actual data

**E2E Tests**:
- Full MCP JSON-RPC request/response cycle
- Complex scenarios with multiple stories and dependencies
- Verify status changes are persisted
- Test empty response handling

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-27 | 1.0 | Initial story creation with comprehensive requirements | Scrum Master |
| 2025-07-27 | 1.1 | Fixed critical issues: Added Task 0 for missing priority/created_at fields, clarified empty response format, updated data model documentation | Product Owner |

## Dev Agent Record

### Agent Model Used
<!-- To be filled by implementing developer -->

### Debug Log References
<!-- To be filled during implementation -->

### Completion Notes List
<!-- To be filled during implementation -->

### File List
<!-- To be filled with created/modified files -->

## QA Results
<!-- To be filled by QA reviewer -->