# Story 6.4: Implement Unified Commenting System

**Status:** ToDo

**Epic:** 6.0 Agent Workflow & Model Enhancements

**Story:**

**As a** QA Agent,
**I want** to add a structured comment to a story, with my role and a timestamp,
**so that** I can provide clear, auditable feedback to the Developer Agent.

**Acceptance Criteria:**

1. A `Comment` data model is created with `author_role`, `content`, `timestamp`, and an optional `reply_to_id`.
2. The `author_role` field MUST be an enumeration of predefined roles (e.g., `Developer Agent`, `QA Agent`, `Scrum Master`, `Product Owner`, `Human Reviewer`).
3. A `story.addComment` tool is created that accepts a `story_id` and a `Comment` object, validating the `author_role` against the predefined list.
4. The `backlog.getStory` tool is updated to include the full list of comments, ordered chronologically.

**Tasks / Subtasks:**

- [ ] **Create Comment Data Model** (AC: 1)
  - [ ] Create `Comment` model in `src/agile_mcp/models/comment.py`
  - [ ] Add SQLAlchemy mapping with id, story_id (foreign key), author_role, content, timestamp
  - [ ] Add optional reply_to_id field for threaded comments
  - [ ] Add relationship to Story model (many-to-one)
  - [ ] Add self-referential relationship for reply threading
  - [ ] Add to_dict() method and CommentResponse Pydantic model

- [ ] **Create Author Role Enumeration** (AC: 2)
  - [ ] Define AuthorRole enum with predefined values
  - [ ] Include roles: Developer Agent, QA Agent, Scrum Master, Product Owner, Human Reviewer
  - [ ] Add System role for automated comments
  - [ ] Ensure enum validation in Comment model
  - [ ] Add helper methods for role validation and display

- [ ] **Implement Comment Validation and Constraints**
  - [ ] Add content validation (non-empty, maximum length)
  - [ ] Add timestamp auto-generation on creation
  - [ ] Add foreign key constraint validation for story_id
  - [ ] Add self-reference validation for reply_to_id
  - [ ] Prevent circular reply chains in threaded comments

- [ ] **Create story.addComment Tool** (AC: 3)
  - [ ] Create `story.addComment` tool in comment_tools.py
  - [ ] Accept story_id and comment data as parameters
  - [ ] Validate author_role against predefined enumeration
  - [ ] Validate story_id exists before creating comment
  - [ ] Validate reply_to_id exists if provided
  - [ ] Return created comment with generated timestamp and ID

- [ ] **Update Story-Comment Relationship** (AC: 4)
  - [ ] Add comments relationship property to Story model
  - [ ] Configure relationship to load comments ordered by timestamp
  - [ ] Update Story model's to_dict() to include comments
  - [ ] Ensure efficient loading of comments with story data
  - [ ] Add comment count property to Story model

- [ ] **Update backlog.getStory Tool** (AC: 4)
  - [ ] Modify tool to include full comments list in response
  - [ ] Ensure comments are ordered chronologically (oldest first)
  - [ ] Include comment threading structure if replies exist
  - [ ] Optimize query to load story and comments efficiently
  - [ ] Handle stories with no comments gracefully

- [ ] **Create Comment Management Utilities**
  - [ ] Create CommentService for business logic operations
  - [ ] Create CommentRepository for data access patterns
  - [ ] Add comment search and filtering utilities
  - [ ] Create comment formatting and display helpers
  - [ ] Add comment validation and sanitization utilities

- [ ] **Implement Comment Threading Support**
  - [ ] Design reply chain structure and validation
  - [ ] Add utilities for building comment trees
  - [ ] Implement reply depth limits to prevent deep nesting
  - [ ] Create comment thread navigation helpers
  - [ ] Add support for comment thread collapse/expand

- [ ] **Create Additional Comment Tools**
  - [ ] Create `story.updateComment` tool for comment editing
  - [ ] Create `story.deleteComment` tool for comment removal
  - [ ] Create `story.getComments` tool for comment-only retrieval
  - [ ] Add proper authorization checks for comment operations
  - [ ] Implement comment audit trail for changes

- [ ] **Create Unit Tests for Comment System**
  - [ ] Test Comment model validation and constraints
  - [ ] Test AuthorRole enumeration validation
  - [ ] Test story.addComment tool with valid/invalid data
  - [ ] Test comment threading and reply functionality
  - [ ] Test comment ordering and retrieval
  - [ ] Test error handling for invalid story_id and author_role

- [ ] **Integration Tests for Story-Comment Workflow**
  - [ ] Test complete workflow: create story -> add comments -> retrieve story
  - [ ] Test comment threading with multiple reply levels
  - [ ] Test comment system with multiple agent roles
  - [ ] Test performance with stories containing many comments
  - [ ] Test comment system integration with enhanced story model

- [ ] **Database Migration and Schema Updates**
  - [ ] Create migration for Comment table creation
  - [ ] Add foreign key constraints and indexes
  - [ ] Ensure proper referential integrity setup
  - [ ] Test migration with existing story data
  - [ ] Verify comment-story relationship queries perform well

**Dev Notes:**

**Context from PRD:**
This story implements a structured commenting system that enables clear, auditable communication between different agent roles. Comments provide contextual feedback and discussion history that enhances the self-sufficient story model.

**Technical Implementation:**
- Use SQLAlchemy relationships for efficient story-comment loading
- Implement proper enum validation for author roles
- Design for extensibility with reply threading capability
- Ensure robust validation and error handling for comment operations

**Dependencies:**
- **REQUIRED**: Story 6.3 (Story Data Model) - Comments relationship to enhanced Story model
- **RECOMMENDED**: Story 6.1 (Project Entity) - Better organizational context
- Foundation for Stories 6.5, 6.6 (tools that consume stories with comments)

**Comment System Architecture:**
```
Story (1) -----> (*) Comment
Comment (1) ---> (0..1) Comment (reply_to)
Comment.author_role -> AuthorRole Enum
```

**Author Role Design:**
- `Developer Agent`: Technical implementation feedback
- `QA Agent`: Quality assurance and testing feedback
- `Scrum Master`: Process and coordination feedback
- `Product Owner`: Requirements and acceptance feedback
- `Human Reviewer`: Manual review and approval feedback
- `System`: Automated system-generated comments

**Comment Threading Strategy:**
- Support one level of replies initially (reply_to_id)
- Prevent circular references through validation
- Order comments chronologically within threads
- Design for future multi-level threading expansion

**Audit and Traceability:**
- Immutable timestamp on creation
- Author role provides clear attribution
- Content history for accountability
- Integration with story lifecycle tracking

**Performance Considerations:**
- Efficient loading of comments with stories
- Proper indexing on story_id and timestamp
- Pagination support for stories with many comments
- Optimized queries for comment threading

**Change Log:**

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-31 | 1.0 | Created missing Unified Commenting System story from Epic PRD | Sarah (PO) |
